# .github/workflows/frontend.yml íŒŒì¼ ë‚´ìš©

name: Frontend CI/CD to S3 and CloudFront

on:
  push:
    branches:
      - master # ğŸ’¡ í”„ë¡ íŠ¸ì—”ë“œ ë¸Œëœì¹˜ masterì— ì½”ë“œê°€ ë³‘í•©ë  ë•Œ ì‹¤í–‰

# GitHub Secretsì—ì„œ ê°’ì„ ë¶ˆëŸ¬ì™€ í™˜ê²½ ë³€ìˆ˜ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
  CLOUDFRONT_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
  # ğŸ’¡ í”„ë¡œì íŠ¸ íŒŒì¼ì´ web-front ë””ë ‰í† ë¦¬ ì•ˆì— ìˆìœ¼ë¯€ë¡œ,
  #    ë¹Œë“œ ë° ì—…ë¡œë“œ ì‹œ ì´ ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
  PROJECT_ROOT: web-front 
  BUILD_DIRECTORY: build # web-front/build/ì— ìµœì¢… ë¹Œë“œ ê²°ê³¼ë¬¼ì´ ìœ„ì¹˜í•œë‹¤ê³  ê°€ì •

jobs:
  deploy:
    name: Build and Deploy to S3/CloudFront
    runs-on: ubuntu-latest
    permissions:
      id-token: write # OIDC ì¸ì¦ì„ ìœ„í•´ í•„ìˆ˜
      contents: read # ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒí•˜ê¸° ìœ„í•´ í•„ìš”

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- 1ë‹¨ê³„: Node í™˜ê²½ ì„¤ì • ë° ë¹Œë“œ ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18' # í”„ë¡œì íŠ¸ì— ë§ëŠ” Node ë²„ì „ìœ¼ë¡œ ë³€ê²½
          cache: 'npm'
          cache-dependency-path: ${{ env.PROJECT_ROOT }}/package-lock.json # web-front ë‚´ë¶€ì˜ package-lock ì‚¬ìš©
      
      - name: Install dependencies and build
        run: |
          cd ${{ env.PROJECT_ROOT }} # ğŸ’¡ web-front ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          npm install
          npm run build
          
      # --- 2ë‹¨ê³„: AWS ì¸ì¦ (OIDCë¥¼ í†µí•´ IAM Role ê¶Œí•œ íšë“) ---
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN_FRONTEND }}
          aws-region: ${{ env.AWS_REGION }}

      # --- 3ë‹¨ê³„: S3 ì—…ë¡œë“œ (ë°°í¬) ---
      - name: Upload static files to S3
        uses: aws-actions/aws-cli-action@v2
        with:
          # ğŸ’¡ web-front/build/ ë””ë ‰í† ë¦¬ì˜ ë‚´ìš©ì„ S3 ë²„í‚· ë£¨íŠ¸ë¡œ ë™ê¸°í™”
          cmd: aws s3 sync ${{ env.PROJECT_ROOT }}/${{ env.BUILD_DIRECTORY }}/ s3://${{ env.S3_BUCKET_NAME }}/ --delete 
          
      # --- 4ë‹¨ê³„: CloudFront ìºì‹œ ë¬´íš¨í™” (Invalidation) ---
      - name: CloudFront Invalidation (ìºì‹œ ê°±ì‹ )
        run: |
          echo "Clearing CloudFront cache for distribution ${{ env.CLOUDFRONT_ID }}"
          aws cloudfront create-invalidation --distribution-id ${{ env.CLOUDFRONT_ID }} --paths "/*"