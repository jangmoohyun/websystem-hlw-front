# .github/workflows/frontend.yml íŒŒì¼ ë‚´ìš©

name: Frontend CI/CD to S3 and CloudFront (Mirroring)

on:
  push:
    branches:
      - master # ë¯¸ëŸ¬ë§ ëŒ€ìƒ ë¸Œëœì¹˜ (master)ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰

# GitHub Secretsì—ì„œ ê°’ì„ ë¶ˆëŸ¬ì™€ í™˜ê²½ ë³€ìˆ˜ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
  CLOUDFRONT_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
  PROJECT_ROOT: web-front # ì†ŒìŠ¤ ì½”ë“œ ë””ë ‰í† ë¦¬
  BUILD_DIRECTORY: dist # ğŸ’¡ ìµœì¢… ë¹Œë“œ ê²°ê³¼ë¬¼ í´ë” (buildê°€ ì•„ë‹Œ distë¡œ ê°€ì •)
  VITE_BACKEND_URL: ${{ secrets.VITE_BACKEND_URL }} # ë°±ì—”ë“œ ALB ì—”ë“œí¬ì¸íŠ¸

jobs:
  deploy:
    name: Build and Deploy to S3/CloudFront
    runs-on: ubuntu-latest
    permissions:
      id-token: write # OIDC ì¸ì¦ì„ ìœ„í•´ í•„ìˆ˜
      contents: read 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- 1ë‹¨ê³„: Node í™˜ê²½ ì„¤ì • ë° ë¹Œë“œ ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22' # ğŸ’¡ Node.js ë²„ì „ì„ 22ë¡œ ê°•ì œ ì§€ì • (Vite ì˜¤ë¥˜ í•´ê²°)
          cache: 'npm'
          cache-dependency-path: ${{ env.PROJECT_ROOT }}/package-lock.json 
      
      - name: Install dependencies and build
        env:
          VITE_BACKEND_URL: ${{ env.VITE_BACKEND_URL }}
        run: |
          cd ${{ env.PROJECT_ROOT }} # web-front ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          npm install
          npm run build
          
      # --- 2ë‹¨ê³„: AWS ì¸ì¦ (OIDCë¥¼ í†µí•´ IAM Role ê¶Œí•œ íšë“) ---
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN_FRONTEND }}
          aws-region: ${{ env.AWS_REGION }}

      # --- 3ë‹¨ê³„: S3 ì—…ë¡œë“œ (ë°°í¬) - Docker ì´ë¯¸ì§€ ì§ì ‘ í˜¸ì¶œ ---
      - name: Upload static files to S3
        # ğŸ’¡ aws-cli ì•¡ì…˜ ëŒ€ì‹  Docker ì´ë¯¸ì§€ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì—¬ ì•¡ì…˜ ì ‘ê·¼ ì˜¤ë¥˜ í•´ê²°
        uses: docker://amazon/aws-cli:2.15.20 
        with:
          # S3 ë™ê¸°í™” ëª…ë ¹ì–´
          args: s3 sync ${{ env.PROJECT_ROOT }}/${{ env.BUILD_DIRECTORY }}/ s3://${{ env.S3_BUCKET_NAME }}/ --delete 
          
      # --- 4ë‹¨ê³„: CloudFront ìºì‹œ ë¬´íš¨í™” (Invalidation) - Docker ì´ë¯¸ì§€ ì§ì ‘ í˜¸ì¶œ ---
      - name: CloudFront Invalidation (ìºì‹œ ê°±ì‹ )
        # ğŸ’¡ aws-cli ì•¡ì…˜ ëŒ€ì‹  Docker ì´ë¯¸ì§€ë¥¼ ì§ì ‘ í˜¸ì¶œ
        uses: docker://amazon/aws-cli:2.15.20 
        with:
          # CloudFront ìºì‹œ ë¬´íš¨í™” ëª…ë ¹ì–´
          args: cloudfront create-invalidation --distribution-id ${{ env.CLOUDFRONT_ID }} --paths "/*"