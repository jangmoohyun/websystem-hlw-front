# .gitlab-ci.yml íŒŒì¼ ë‚´ìš©

stages:
  - build
  - deploy

variables:
  # ğŸ’¡ GitHub Secretsê³¼ ë™ì¼í•œ ë³€ìˆ˜ëª…ì„ GitLab Variablesì— ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.
  # Settings -> CI/CD -> Variables (Variables íƒ­ì— ë“±ë¡ í•„ìš”)
  PROJECT_ROOT: web-front
  BUILD_DIRECTORY: build 

# --- Build Stage: ë¹Œë“œ ---
build_job:
  stage: build
  image: node:18-alpine # Node.js 18 í™˜ê²½ ì‚¬ìš©
  only:
    - master # master ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§Œ ì‹¤í–‰
  script:
    - cd $PROJECT_ROOT # web-front ë””ë ‰í† ë¦¬ë¡œ ì´ë™
    - npm install
    - npm run build
  artifacts:
    expire_in: 1 week
    paths:
      - web-front/build/ # ë¹Œë“œ ê²°ê³¼ë¬¼ì„ ë‹¤ìŒ deploy stageë¡œ ì „ë‹¬

# --- Deploy Stage: S3 ì—…ë¡œë“œ ë° CloudFront ê°±ì‹  ---
deploy_job:
  stage: deploy
  image: 
    # AWS CLI ë° OIDC ì¸ì¦ì— í•„ìš”í•œ íŒ¨í‚¤ì§€ê°€ í¬í•¨ëœ Docker ì´ë¯¸ì§€ ì‚¬ìš©
    name: amazon/aws-cli:2.15.20 # ì•ˆì •ì ì¸ AWS CLI ì´ë¯¸ì§€
    entrypoint: [""]
  only:
    - master
  dependencies:
    - build_job # build_jobì˜ ê²°ê³¼ë¬¼(artifacts)ì„ ì‚¬ìš©

  script:
    # 1. OIDCë¥¼ ì‚¬ìš©í•˜ì—¬ ì„ì‹œ AWS ìê²© ì¦ëª… íšë“ (OIDC ì¸ì¦)
    # AWS_IAM_ROLE_ARN_FRONTEND ë³€ìˆ˜ëŠ” GitLab CI/CD Variablesì— ë“±ë¡ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
    - TEMP_CREDENTIALS=$(aws sts assume-role-with-web-identity --role-arn $AWS_IAM_ROLE_ARN_FRONTEND --role-session-name "GitLabSession" --web-identity-token $CI_JOB_JWT --duration-seconds 3600 --output json)
    - export AWS_ACCESS_KEY_ID=$(echo $TEMP_CREDENTIALS | jq -r '.Credentials.AccessKeyId')
    - export AWS_SECRET_ACCESS_KEY=$(echo $TEMP_CREDENTIALS | jq -r '.Credentials.SecretAccessKey')
    - export AWS_SESSION_TOKEN=$(echo $TEMP_CREDENTIALS | jq -r '.Credentials.SessionToken')
    - export AWS_REGION=$AWS_REGION # AWS_REGION ë³€ìˆ˜ë„ Variablesì— ë“±ë¡ë˜ì–´ì•¼ í•¨

    # 2. S3 ì—…ë¡œë“œ (ë°°í¬)
    - aws s3 sync $PROJECT_ROOT/$BUILD_DIRECTORY/ s3://$S3_BUCKET_NAME/ --delete 
    
    # 3. CloudFront ìºì‹œ ë¬´íš¨í™”
    - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_ID --paths "/*"